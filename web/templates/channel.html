<!doctype html>
<html lang="en">

<head>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/nav.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/puzzle.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/slider.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/win.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/bootstrap.min.css') }}">
  <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/socket.io/2.2.0/socket.io.slim.js"></script>
  <script src="//code.jquery.com/jquery-3.2.1.slim.min.js"></script>
  <script type="text/javascript" src="{{ url_for('static', filename='js/bootstrap.bundle.min.js') }}"></script>
  <script type="text/javascript" src="{{ url_for('static', filename='js/crossword.js') }}"></script>
  <script type="text/javascript" src="{{ url_for('static', filename='js/win.js') }}"></script>
</head>

<body>
  <nav class="navbar navbar-expand navbar-dark text-light bg-dark">
    <div class="navbar-brand">Twitch Plays Crosswords</div>

    {% if streamer %}
    <div id="error-message" class="navbar-text text-danger ml-auto mr-auto invisible">Error message here.</div>
    <ul class="navbar-nav ml-auto">
      <button id="start-pause" type="button" class="btn btn-success invisible">Start</button>

      <!-- Views dropdown -->
      <li class="nav-item dropdown">
        <button id="views-dropdown" type="button" class="btn btn-dark dropdown-toggle" data-toggle="dropdown">
          Views
        </button>
        <div id="views-dropdown-menu" class="dropdown-menu dropdown-menu-right" aria-labelledby="views-dropdown">
          <form>
            <div class="dropdown-item">
              <div class="lead">Streamer View</div>
              <div>
                <small class="text-muted">
                  This link allows changing of settings as well as the active puzzle. Only share it
                  with those you fully trust.
                </small>
              </div>
              <input type="text" class="form-control" value="{{ url_for('streamer', channel=owner, _external=True)}}" />
            </div>
            <div class="dropdown-divider"></div>
            <div class="dropdown-item">
              <div class="lead">Progress View</div>
              <div>
                <small class="text-muted">
                  This link will only show the progress of the puzzle solve. As cells are
                  populated with values they will change color, but the value put in the
                  cells will not be visible. This link is intended to be shared with
                  others who are solving the puzzle at the same time, but shouldn't see
                  any answers.
                </small>
              </div>
              <input type="text" class="form-control" value="{{ url_for('progress', channel=owner, _external=True)}}" />
            </div>
            <div class="dropdown-divider"></div>
            <div class="dropdown-item">
              <div class="lead">Participant View</div>
              <div>
                <small class="text-muted">
                  This link will show the complete progress of the solve as it happens
                  in real-time. This link is safe to share with anyone.
                </small>
              </div>
              <input type="text" class="form-control" value="{{ url_for('channel', channel=owner, _external=True)}}" />
            </div>
          </form>
        </div>
      </li>

      <!-- Settings dropdown -->
      <li class="nav-item dropdown">
        <button id="settings-dropdown" type="button" class="btn btn-dark dropdown-toggle" data-toggle="dropdown">
          Settings
        </button>
        <div id="settings-dropdown-menu" class="dropdown-menu dropdown-menu-right" aria-labelledby="settings-dropdown">
          <form>
            <div class="dropdown-item">
              <div class="lead">Only correct answers</div>
              <div>
                <small class="text-muted">
                  This setting enables the behavior that only correct answers or correct partial
                  answers will be accepted. With this enabled a cell in the puzzle can never
                  contain an incorrect value.
                </small>
              </div>
              <label class="switch">
                <input id="correct-answers-only" type="checkbox" class="form-check-input success" />
                <span class="slider round"></span>
              </label>
            </div>
            <div class="dropdown-divider"></div>
            <div class="dropdown-item">
              <div class="lead">Reduced set of clues</div>
              <div>
                <small class="text-muted">
                  This setting enables some of the clues to be hidden thus making the puzzle
                  significantly more difficult to solve.
                </small>
              </div>
              <div class="btn-group" role="group">
                <button id="show-all-clues" type="button" class="btn btn-dark">Show All</button>
                <button id="hide-across-clues" type="button" class="btn btn-dark">Hide Across</button>
                <button id="hide-down-clues" type="button" class="btn btn-dark">Hide Down</button>
              </div>
            </div>
            <div class="dropdown-divider"></div>
            <div class="dropdown-item">
              <div class="lead">Clue font size</div>
              <div>
                <small class="text-muted">
                  This setting allows the size of the font used to render clues to be adjusted.
                </small>
              </div>
              <div class="btn-group" role="group">
                <button id="font-size-clues-normal" type="button" class="btn btn-dark">Normal</button>
                <button id="font-size-clues-large" type="button" class="btn btn-dark">Large</button>
                <button id="font-size-clues-xlarge" type="button" class="btn btn-dark">Extra Large</button>
              </div>
            </div>
          </form>
        </div>
      </li>

      <!-- Puzzle dropdown -->
      <li class="nav-item dropdown">
        <button id="puzzle-dropdown" type="button" class="btn btn-dark dropdown-toggle" data-toggle="dropdown">
          Puzzle
        </button>
        <div id="puzzle-dropdown-menu" class="dropdown-menu dropdown-menu-right" aria-labelledby="puzzle-dropdown">
          <form>
            <div class="dropdown-item">
              <div class="lead">New York Times</div>
              <div>
                <small class="text-muted">
                  Select a date to solve that day's puzzle from the archives of
                  the New York Times.
                </small>
              </div>
              <div class="input-group">
                <input id="date-selector" type="date" class="form-control"></input>
                <div class="input-group-append">
                  <button id="date-selector-button" type="button" class="btn btn-dark">Load</button>
                </div>
              </div>
            </div>
            <div class="dropdown-divider"></div>
            <div class="dropdown-item">
              <div class="lead">Download a .puz file</div>
              <div>
                <small class="text-muted">
                  Input a URL to a .puz file to solve an existing puzzle hosted
                  somewhere online.
                </small>
              </div>
              <div class="input-group">
                <input id="url-selector" type="url" class="form-control"></input>
                <div class="input-group-append">
                  <button id="url-selector-button" type="button" class="btn btn-dark">Load</button>
                </div>
              </div>
            </div>
            <div class="dropdown-divider"></div>
            <div class="dropdown-item">
              <div class="lead">Upload a .puz file</div>
              <div>
                <small class="text-muted">
                  Upload your own puzzle file in .puz format. More info about
                  the .puz file format can be found
                  <a href="http://fileformats.archiveteam.org/wiki/PUZ_(crossword_puzzles)">here</a>.
                </small>
              </div>
              <div class="input-group">
                <button id="file-upload-button" type="button" class="btn btn-dark">Choose file</button>
                <input id="file-selector" type="file" class="d-none" accept=".puz"></input>
              </div>
            </div>
          </form>
        </div>
      </li>
    </ul>
    {% endif %}
  </nav>

  <div id="crossword">
    <div class="puzzle">
      <div class="header">
        <div id="title" class="title">Title goes here.</div>
        <div class="author">by&nbsp;<span id="author">Author goes here.</span></div>
        <div id="date" class="date">Date goes here.</div>
        <div id="timer" class="timer">0h 00m 00s</div>
      </div>
      <div id="grid" class="grid">
        Puzzle grid goes here.
      </div>
      <div class="footer">
        <div>Answer a clue: <code>!12a red velvet cake</code></div>
        <div>Partially answer a clue: <code>!12a gr.y goose</code></div>
        <div>Answer with a rebus: <code>!12a (gray)goose</code></div>
        <div>Make a clue visible: <code>!show 10d</code></div>
      </div>
    </div>
    <div class="clues">
      <div class="content">
        <div class="across">
          <div class="clue-title">Across</div>
          <div id="across-clues" class="clue-list">
            Across clues go here
          </div>
        </div>
        <div class="down">
          <div class="clue-title">Down</div>
          <div id="down-clues" class="clue-list">
            Down clues go here
          </div>
        </div>
      </div>
      <div id="clue-notes" class="notes">
        Notes go here
      </div>
    </div>
  </div>

  <!-- Websocket setup + handlers. -->
  <script type="text/javascript" charset="utf-8">
    // Connect to the server and join the room for this channel owner.  We do
    // this every time we connect so that if we get disconnected we'll
    // automatically rejoin the room upon reconnecting.
    var socket = io();
    socket.on("connect", function () {
      socket.emit("join", "{{ owner }}");
    });

    socket.on("state", function (data) {
      var state = JSON.parse(data);
      set_play_pause(state.play_pause_state);
      render_crossword(state, eval("{{ progress | lower }}"));
      set_date(state.puzzle.published);
      set_timer(state.play_pause_state, state.last_start_time, state.total_time_secs);
    });

    socket.on("settings", function (data) {
      var settings = JSON.parse(data);
      set_settings(settings);
    });

    socket.on("show_clue", function (clue) {
      var clueElem = document.getElementById(clue);
      if (clueElem !== null) {
        clueElem.scrollIntoView();
        clueElem.classList.add("shown");
        setTimeout(function () {
          clueElem.classList.remove("shown");
        }, 2500);
      }
    });

    socket.on("solved", function () {
      // Alert after a second, this gives the UI time to show the last answer
      // before playing the win animation.
      setTimeout(function () {
        start_win_animation();
      }, 1000);
    });

    var errorTimerId = null;
    socket.on("error", function (message) {
      if (errorTimerId !== null) {
        clearTimeout(errorTimerId);
        errorTimerId = null;
      }

      var errorElem = document.getElementById("error-message");
      if (errorElem !== null) {
        errorElem.innerText = message;
        errorElem.classList.remove("invisible");

        errorTimerId = setTimeout(function () {
          errorElem.classList.add("invisible");
        }, 5000);
      }
    });
  </script>

  <!-- Settings menu handlers. -->
  <script type="text/javascript" charset="utf-8">
    var correctAnswersCheckbox = document.getElementById("correct-answers-only");
    if (correctAnswersCheckbox !== null) {
      correctAnswersCheckbox.onchange = function () {
        var value = correctAnswersCheckbox.checked;
        socket.emit("set_settings", {
          "room": "{{ owner }}",
          "settings": {
            "only_allow_correct_answers": value
          }
        });
      }
    }

    var showAllClues = document.getElementById("show-all-clues");
    var hideAcrossClues = document.getElementById("hide-across-clues");
    var hideDownClues = document.getElementById("hide-down-clues");
    if (showAllClues !== null) {
      showAllClues.onclick = function () {
        socket.emit("set_settings", {
          "room": "{{ owner }}",
          "settings": {
            "hide_clues": "none"
          }
        });
      };
    }
    if (hideAcrossClues !== null) {
      hideAcrossClues.onclick = function () {
        socket.emit("set_settings", {
          "room": "{{ owner }}",
          "settings": {
            "hide_clues": "across"
          }
        });
      };
    }
    if (hideDownClues !== null) {
      hideDownClues.onclick = function () {
        socket.emit("set_settings", {
          "room": "{{ owner }}",
          "settings": {
            "hide_clues": "down"
          }
        });
      };
    }

    var clueFontSizeNormal = document.getElementById("font-size-clues-normal");
    var clueFontSizeLarge = document.getElementById("font-size-clues-large");
    var clueFontSizeXLarge = document.getElementById("font-size-clues-xlarge");
    if (clueFontSizeNormal !== null) {
      clueFontSizeNormal.onclick = function () {
        socket.emit("set_settings", {
          "room": "{{ owner }}",
          "settings": {
            "clue_font_size": "normal"
          }
        });
      };
    }
    if (clueFontSizeLarge !== null) {
      clueFontSizeLarge.onclick = function () {
        socket.emit("set_settings", {
          "room": "{{ owner }}",
          "settings": {
            "clue_font_size": "large"
          }
        });
      };
    }
    if (clueFontSizeXLarge !== null) {
      clueFontSizeXLarge.onclick = function () {
        socket.emit("set_settings", {
          "room": "{{ owner }}",
          "settings": {
            "clue_font_size": "xlarge"
          }
        });
      };
    }
  </script>

  <!-- Puzzle menu handlers. -->
  <script type="text/javascript" charset="utf-8">
    function getDateString(d) {
      var year = d.getFullYear();

      var month = d.getMonth() + 1;
      if (month < 10) {
        month = "0" + month;
      }

      var day = d.getDate();
      if (day < 10) {
        day = "0" + day;
      }

      return year + "-" + month + "-" + day;
    }

    var puzzleDropdown = document.getElementById("puzzle-dropdown");

    var dateSelector = document.getElementById("date-selector");
    var dateSelectorButton = document.getElementById("date-selector-button");
    if (dateSelector !== null && dateSelectorButton !== null) {
      // We can only get puzzles between 1942-02-15 and today.
      dateSelector.min = "1942-02-15";
      dateSelector.max = getDateString(new Date());

      // When the load button is clicked let the server know.
      dateSelectorButton.onclick = function () {
        var date = dateSelector.value;
        if (date !== "") {
          socket.emit("set_puzzle", { "room": "{{ owner }}", "date": date });
        }

        if (puzzleDropdown !== null) {
          $(puzzleDropdown).dropdown("toggle");
        }
      };
    }

    var urlSelector = document.getElementById("url-selector");
    var urlSelectorButton = document.getElementById("url-selector-button");
    if (urlSelector !== null && urlSelectorButton !== null) {
      urlSelectorButton.onclick = function () {
        var url = urlSelector.value;
        if (url !== "") {
          socket.emit("set_puzzle", { "room": "{{ owner }}", "url": url });
        }

        if (puzzleDropdown !== null) {
          $(puzzleDropdown).dropdown("toggle");
        }
      };
    }

    var fileSelector = document.getElementById("file-selector");
    var fileSelectorButton = document.getElementById("file-upload-button");
    if (fileSelector !== null && fileSelectorButton !== null) {
      fileSelectorButton.onclick = function () {
        fileSelector.click();

        if (puzzleDropdown !== null) {
          $(puzzleDropdown).dropdown("toggle");
        }
      };

      fileSelector.onchange = function (e) {
        var file = e.target.files[0];
        if (!file) {
          return;
        }

        var reader = new FileReader();
        reader.onload = function (e) {
          var bytes = e.target.result;
          if (!bytes) {
            return;
          }

          // Encode the bytes as base64 so they're compatible with json.
          bytes = btoa(bytes);

          socket.emit("set_puzzle", { "room": "{{ owner }}", "bytes": bytes });
        };
        reader.readAsBinaryString(file);
      };
    }
  </script>

  <!-- Start/Pause/Unpause button handler. -->
  <script type="text/javascript" charset="utf-8">
    var startPauseButton = document.getElementById("start-pause");
    if (startPauseButton !== null) {
      startPauseButton.onclick = function () {
        socket.emit("play_pause", {
          "room": "{{ owner }}",
        });
      }
    }
  </script>
</body>

</html>